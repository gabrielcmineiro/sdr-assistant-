<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - SDR Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lead-info h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .lead-meta {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sdr-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
        }

        .phase-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .phase-abertura {
            background: #fef3c7;
            color: #92400e;
        }

        .phase-transicao {
            background: #dbeafe;
            color: #1e40af;
        }

        .phase-objecao {
            background: #fee2e2;
            color: #991b1b;
        }

        .phase-agendamento {
            background: #d1fae5;
            color: #065f46;
        }

        .phase-desqualificado {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            max-width: 600px;
        }

        .status-controls .btn-row-1,
        .status-controls .btn-row-2 {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: white;
            color: #667eea;
        }

        .btn.active {
            background: white;
            color: #667eea;
        }

        .chat-container {
            flex: 1;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.lead {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.lead .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .message.lead .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.assistant .message-avatar {
            background: #e9ecef;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 14px;
        }

        .message.lead .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: #f1f3f5;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        /* Markdown styling */
        .message-content p {
            margin: 0 0 10px 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content strong {
            font-weight: 600;
            color: #667eea;
        }

        .message-content ul,
        .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 5px 0;
            line-height: 1.5;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .message-content h1 { font-size: 18px; }
        .message-content h2 { font-size: 16px; }
        .message-content h3 { font-size: 14px; }

        .message-content code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .message-content pre {
            background: #2d3748;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .message-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .chat-input-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 12px;
            background: #f1f3f5;
            border-radius: 12px;
            margin-bottom: 20px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .modal-btn-secondary {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
        }

        .modal-btn-danger {
            background: #dc3545;
            color: white;
            border: none;
        }

        /* Rating Modal */
        .rating-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .rating-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-width: 300px;
            z-index: 1000;
            display: none;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <div class="chat-header-content">
            <div class="lead-info">
                <h1 id="leadName">Carregando...</h1>
                <div class="lead-meta" id="leadMeta">
                    <span>Carregando informa√ß√µes...</span>
                </div>
            </div>
            <div class="status-controls">
                <div class="btn-row-1">
                    <button class="btn" onclick="goHome()">üè† Dashboard</button>
                    <button class="btn" onclick="showRatingModal()">‚≠ê Avaliar</button>
                    <button class="btn" onclick="showDeleteModal()">üóëÔ∏è Apagar</button>
                </div>
                <div class="btn-row-2">
                    <button class="btn" onclick="markAsScheduled()">‚úÖ Agenda</button>
                    <button class="btn" onclick="markAsInProgress()">üü° Em Andamento</button>
                    <button class="btn" onclick="showLostModal()">‚ùå Lost</button>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Cole aqui a resposta do lead no Instagram/LinkedIn..."
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Enviar ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Modal Rating -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">‚≠ê Avaliar Sugest√µes do Claude</div>
            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                De 0 a 10, quanto as sugest√µes ajudaram nesta conversa?
            </p>
            <div class="rating-buttons">
                <button class="rating-btn" data-rating="0" onclick="selectRating(0)">0</button>
                <button class="rating-btn" data-rating="1" onclick="selectRating(1)">1</button>
                <button class="rating-btn" data-rating="2" onclick="selectRating(2)">2</button>
                <button class="rating-btn" data-rating="3" onclick="selectRating(3)">3</button>
                <button class="rating-btn" data-rating="4" onclick="selectRating(4)">4</button>
                <button class="rating-btn" data-rating="5" onclick="selectRating(5)">5</button>
                <button class="rating-btn" data-rating="6" onclick="selectRating(6)">6</button>
                <button class="rating-btn" data-rating="7" onclick="selectRating(7)">7</button>
                <button class="rating-btn" data-rating="8" onclick="selectRating(8)">8</button>
                <button class="rating-btn" data-rating="9" onclick="selectRating(9)">9</button>
                <button class="rating-btn" data-rating="10" onclick="selectRating(10)">10</button>
            </div>
            <textarea class="modal-input" id="ratingComments" placeholder="Coment√°rios (opcional)"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeRatingModal()">Cancelar</button>
                <button class="modal-btn modal-btn-primary" onclick="saveRating()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Lost -->
    <div class="modal" id="lostModal">
        <div class="modal-content">
            <div class="modal-header">‚ùå Marcar como Perdida</div>
            <textarea class="modal-input" id="lostReason" placeholder="Motivo (ex: Lead n√£o respondeu, Sem interesse, etc.)"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeLostModal()">Cancelar</button>
                <button class="modal-btn modal-btn-danger" onclick="markAsLost()">Confirmar Lost</button>
            </div>
        </div>
    </div>

    <!-- Modal Delete -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">üóëÔ∏è Apagar Conversa</div>
            <p style="margin-bottom: 20px; color: #666;">
                Tem certeza que deseja apagar esta conversa? Esta a√ß√£o n√£o pode ser desfeita.
            </p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button class="modal-btn modal-btn-danger" onclick="deleteConversation()">Apagar</button>
            </div>
        </div>
    </div>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">üêõ Debug</button>
    <div class="debug-panel" id="debugPanel">
        <div id="debugContent">Aguardando...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="config.js"></script>
    <script>
        // =====================================================
        // CONFIGURA√á√ÉO POR SDR
        // =====================================================
        const SDR_NAMES = {
            'thaina': 'Thain√°',
            'gabriel': 'Gabriel',
            'jeni': 'Jeni'
        };

        const PROXY_URL = CONFIG.PROXY_URL;
        
        let supabaseClient;
        let agentConfig;
        let agentPrompts = {};
        let conversationId;
        let conversation;
        let messages = [];
        let selectedRating = null;
        let debugMode = false;
        let currentSDR = null;

        // =====================================================
        // FUN√á√ïES DE SDR
        // =====================================================

        function getStorageKey() {
            return currentSDR ? `sdrAgentConfig_${currentSDR}` : 'sdrAgentConfig';
        }

        function getSdrName() {
            return SDR_NAMES[currentSDR] || currentSDR || 'SDR';
        }

        // =====================================================
        // SISTEMA MODULAR DE PROMPTS - DETEC√á√ÉO DE VARI√ÅVEIS
        // =====================================================

        const areaKeywords = [
            'marketing', 'growth', 'm√≠dia', 'media', 'performance',
            'conte√∫do', 'conteudo', 'branding', 'brand', 'crm',
            'produto', 'product', 'aquisi√ß√£o', 'aquisicao',
            'comunica√ß√£o', 'comunicacao', 'digital', 'social media',
            'inbound', 'outbound', 'demand gen', 'demanda',
            'analytics', 'dados', 'bi', 'seo', 'sem', 'paid media',
            'lifecycle', 'retention', 'engajamento', 'convers√£o',
            'analista de marketing', 'coordenador de marketing',
            'gerente de marketing', 'head de marketing', 'cmo',
            'diretor de marketing', 'especialista de marketing',
            'analista de growth', 'growth manager', 'head de growth',
            'product marketing', 'pmm', 'brand manager'
        ];

        const dorKeywords = [
            'travado', 'travada', 'parado', 'parada', 'estagnado', 'estagnada',
            'mesmo lugar', 'n√£o saio do lugar', 'n√£o sai do lugar',
            'patinando', 'girando em c√≠rculos',
            'invis√≠vel', 'invisivel', 'ningu√©m v√™', 'ninguem ve',
            'n√£o reconhecem', 'nao reconhecem', 'n√£o sou visto', 'n√£o sou vista',
            'fa√ßo muito', 'entrego muito', 'trabalho muito',
            'perdido', 'perdida', 'sem dire√ß√£o', 'sem direcao',
            'n√£o sei', 'nao sei', 'confuso', 'confusa',
            'sem rumo', 'sem norte', 'sem foco',
            'frustrado', 'frustrada', 'cansado', 'cansada',
            'decepcionado', 'decepcionada', 'desanimado', 'desanimada',
            'incomodado', 'incomodada',
            'n√£o me sinto preparado', 'n√£o me sinto preparada',
            'n√£o sou bom', 'n√£o sou boa', 'impostor', 'impostora',
            'inseguro', 'insegura',
            'movimento lateral', 'movimentos laterais',
            'batendo na trave', 'bate na trave',
            'quase consigo', 'sempre chego perto'
        ];

        const ambicaoKeywords = [
            'quero crescer', 'quero evoluir', 'quero subir',
            'quero ser promovido', 'quero ser promovida',
            'quero ganhar mais', 'quero aumentar',
            'pr√≥ximo passo', 'proximo passo', 'pr√≥ximo n√≠vel', 'proximo nivel',
            'virar gerente', 'virar head', 'virar diretor', 'virar diretora',
            'chegar em', 'chegar a', 'alcan√ßar', 'alcancar',
            'acelerar', 'alavancar', 'impulsionar',
            'sair de analista', 'sair de coordenador',
            'quero mais', 'busco mais', 'mere√ßo mais'
        ];

        const sessaoKeywords = [
            'sess√£o de diagn√≥stico', 'sessao de diagnostico',
            'sess√£o estrat√©gica', 'sessao estrategica',
            'diagn√≥stico de carreira', 'diagnostico de carreira',
            '40 minutos', '40 min', 'gratuita',
            'quer ver os hor√°rios', 'quer agendar'
        ];

        const objecoes = {
            dinheiro: [
                'caro', 'n√£o tenho dinheiro', 'nao tenho dinheiro',
                'n√£o posso investir', 'nao posso investir',
                'n√£o tenho grana', 'nao tenho grana',
                't√° caro', 'ta caro', 'muito caro',
                'sem dinheiro', 'sem grana', 'sem verba',
                'n√£o cabe no or√ßamento', 'or√ßamento apertado',
                'momento financeiro', 'financeiramente'
            ],
            tempo: [
                'n√£o tenho tempo', 'nao tenho tempo',
                'sem tempo', 'muito ocupado', 'muito ocupada',
                'correria', 'na correria', 'muito atarefado',
                'agenda cheia', 'agenda lotada', 'agenda apertada',
                'momento complicado', 'fase corrida'
            ],
            duvida: [
                'n√£o sei se', 'nao sei se',
                'n√£o sei se √© pra mim', 'nao sei se √© pra mim',
                'ser√° que', 'sera que',
                'tenho d√∫vida', 'tenho duvida',
                'n√£o tenho certeza', 'nao tenho certeza',
                'preciso entender melhor'
            ],
            adiamento: [
                'preciso pensar', 'vou pensar',
                'depois', 'mais tarde', 'outro momento',
                'vou ver depois', 'deixa pra depois',
                'agora n√£o', 'agora nao', 'n√£o √© o momento',
                'talvez mais pra frente', 'quem sabe depois'
            ]
        };

        const aceitacaoKeywords = [
            'quero', 'quero sim', 'bora', 'vamos',
            'pode ser', 'faz sentido', 'faz sim',
            'sim', 'claro', 'com certeza',
            'me interessa', 'tenho interesse',
            'como funciona', 'como faz', 'como agendo',
            'qual hor√°rio', 'qual horario', 'que horas',
            'manda o link', 'me manda', 'pode mandar',
            't√¥ dentro', 'to dentro', 'fechado',
            'por mim tudo bem', 'pode agendar'
        ];

        const recusaKeywords = [
            'n√£o quero', 'nao quero',
            'n√£o preciso', 'nao preciso',
            'n√£o √© pra mim', 'nao √© pra mim',
            'n√£o tenho interesse', 'nao tenho interesse',
            'obrigado mas n√£o', 'obrigada mas n√£o',
            'agrade√ßo mas', 'valeu mas',
            'n√£o faz sentido', 'nao faz sentido',
            'passo', 'vou passar', 'dessa vez n√£o',
            'n√£o vai rolar', 'nao vai rolar'
        ];

        const desqualificacaoKeywords = [
            'sou de rh', 'trabalho com rh', 'recursos humanos',
            'sou de vendas', 'comercial', 'closer', 'sdr',
            'sou de ti', 'desenvolvedor', 'programador',
            'sou de financeiro', 'contabilidade',
            'sou advogado', 'sou m√©dico', 'sou engenheiro',
            's√≥ curiosidade', 'so curiosidade',
            's√≥ olhando', 'so olhando',
            's√≥ pra saber', 'so pra saber',
            't√¥ s√≥ acompanhando', 'to so acompanhando'
        ];

        // =====================================================
        // FUN√á√ïES DE DETEC√á√ÉO
        // =====================================================

        function detectarArea(mensagensLead) {
            const textoCompleto = mensagensLead.join(' ').toLowerCase();
            return areaKeywords.some(keyword => textoCompleto.includes(keyword));
        }

        function detectarDor(mensagensLead) {
            const textoCompleto = mensagensLead.join(' ').toLowerCase();
            const temDor = dorKeywords.some(keyword => textoCompleto.includes(keyword));
            const temAmbicao = ambicaoKeywords.some(keyword => textoCompleto.includes(keyword));
            return temDor || temAmbicao;
        }

        function detectarSessaoProposta(mensagensAssistant) {
            const textoCompleto = mensagensAssistant.join(' ').toLowerCase();
            const mencionaSessao = sessaoKeywords.some(keyword => textoCompleto.includes(keyword));
            const ehProposta = textoCompleto.includes('quer') || 
                              textoCompleto.includes('faz sentido') ||
                              textoCompleto.includes('vamos');
            return mencionaSessao && ehProposta;
        }

        function detectarObjecao(ultimaMensagemLead) {
            const texto = ultimaMensagemLead.toLowerCase();
            
            for (const [tipo, keywords] of Object.entries(objecoes)) {
                if (keywords.some(keyword => texto.includes(keyword))) {
                    return { temObjecao: true, tipoObjecao: tipo };
                }
            }
            
            return { temObjecao: false, tipoObjecao: null };
        }

        function detectarAceitacao(ultimaMensagemLead, sessaoProposta) {
            if (!sessaoProposta) return false;
            const texto = ultimaMensagemLead.toLowerCase();
            return aceitacaoKeywords.some(keyword => texto.includes(keyword));
        }

        function detectarRecusa(ultimaMensagemLead) {
            const texto = ultimaMensagemLead.toLowerCase();
            return recusaKeywords.some(keyword => texto.includes(keyword));
        }

        function detectarDesqualificacao(mensagensLead) {
            const textoCompleto = mensagensLead.join(' ').toLowerCase();
            return desqualificacaoKeywords.some(keyword => textoCompleto.includes(keyword));
        }

        // =====================================================
        // DETERMINA√á√ÉO DE ESTADO
        // =====================================================

        function determinarEstado(variaveis) {
            const {
                areaConfirmada,
                dorIdentificada,
                sessaoProposta,
                temObjecao,
                tipoObjecao,
                leadAceitou,
                leadRecusou,
                leadDesqualificado
            } = variaveis;
            
            if (leadDesqualificado || leadRecusou) {
                return 'desqualificado';
            }
            
            if (temObjecao) {
                return 'objecao';
            }
            
            if (sessaoProposta && leadAceitou) {
                return 'agendamento';
            }
            
            if (areaConfirmada && dorIdentificada && !sessaoProposta) {
                return 'transicao';
            }
            
            if (sessaoProposta && !leadAceitou && !leadRecusou && !temObjecao) {
                return 'transicao';
            }
            
            return 'abertura';
        }

        // =====================================================
        // CARREGAMENTO DE M√ìDULOS
        // =====================================================

        const modulosPorEstado = {
            abertura: ['prompt_core', 'prompt_produto', 'prompt_arquetipos', 'prompt_linguagem', 'prompt_abertura'],
            transicao: ['prompt_core', 'prompt_produto', 'prompt_provas', 'prompt_transicao'],
            objecao: ['prompt_core', 'prompt_produto', 'prompt_provas', 'prompt_transicao'],
            agendamento: ['prompt_core', 'prompt_produto', 'prompt_transicao'],
            desqualificado: ['prompt_core']
        };

        const instrucoesPorEstado = {
            abertura: `Voc√™ est√° na fase de ABERTURA/QUALIFICA√á√ÉO.
Seu objetivo: Confirmar se o lead √© de marketing/growth E identificar uma dor ou ambi√ß√£o.
- Se ainda n√£o sabe a √°rea, pergunte de forma natural
- Se ainda n√£o identificou dor, fa√ßa perguntas para descobrir
- Combine perguntas quando poss√≠vel para ganhar velocidade
- Assim que tiver AMBOS (√°rea + dor), avance para propor a sess√£o`,

            transicao: `Voc√™ est√° na fase de TRANSI√á√ÉO.
Seu objetivo: Propor a sess√£o estrat√©gica gratuita.
- O lead j√° est√° qualificado (√°rea + dor confirmados)
- Conecte a dor dele com a proposta da sess√£o
- Seja direta: proponha a sess√£o de diagn√≥stico
- Se ele aceitar, v√° para agendamento`,

            objecao: `Voc√™ est√° na fase de OBJE√á√ÉO.
O lead levantou uma obje√ß√£o.
Seu objetivo: Contornar a obje√ß√£o de forma emp√°tica e n√£o agressiva.
- Valide o sentimento primeiro
- Use os scripts de obje√ß√£o do m√≥dulo
- Lembre que a sess√£o √© GRATUITA (isso resolve maioria das obje√ß√µes)
- Ap√≥s contornar, volte a propor a sess√£o`,

            agendamento: `Voc√™ est√° na fase de AGENDAMENTO.
O lead aceitou fazer a sess√£o!
Seu objetivo: Fechar o hor√°rio.
- Pergunte prefer√™ncia de hor√°rio (manh√£/tarde)
- Envie o link de agendamento
- Confirme e encerre de forma positiva`,

            desqualificado: `O lead n√£o √© do p√∫blico-alvo OU recusou explicitamente.
Seu objetivo: Encerrar de forma gentil e positiva.
- Agrade√ßa o tempo
- Deixe porta aberta para o futuro
- N√£o insista`
        };

        function carregarModulos(estado) {
            const modulosNecessarios = modulosPorEstado[estado] || ['prompt_core'];
            let promptFinal = '';
            
            for (const modulo of modulosNecessarios) {
                const conteudo = agentPrompts[modulo];
                if (conteudo && conteudo.trim() !== '') {
                    promptFinal += conteudo + '\n\n---\n\n';
                }
            }
            
            return promptFinal;
        }

        // =====================================================
        // CONSTRU√á√ÉO DO PROMPT FINAL
        // =====================================================

        function buildSystemPrompt(msgs, context) {
            const mensagensLead = msgs.filter(m => m.role === 'lead').map(m => m.content);
            const mensagensAssistant = msgs.filter(m => m.role === 'assistant').map(m => m.content);
            const ultimaMensagemLead = mensagensLead[mensagensLead.length - 1] || '';
            
            const areaConfirmada = detectarArea(mensagensLead);
            const dorIdentificada = detectarDor(mensagensLead);
            const sessaoProposta = detectarSessaoProposta(mensagensAssistant);
            const { temObjecao, tipoObjecao } = detectarObjecao(ultimaMensagemLead);
            const leadAceitou = detectarAceitacao(ultimaMensagemLead, sessaoProposta);
            const leadRecusou = detectarRecusa(ultimaMensagemLead);
            const leadDesqualificado = detectarDesqualificacao(mensagensLead);
            
            const variaveis = {
                areaConfirmada,
                dorIdentificada,
                sessaoProposta,
                temObjecao,
                tipoObjecao,
                leadAceitou,
                leadRecusou,
                leadDesqualificado
            };
            
            const estado = determinarEstado(variaveis);
            
            logDebug({
                variaveis,
                estado,
                modulosCarregados: modulosPorEstado[estado],
                sdr: currentSDR
            });
            
            const temModulos = agentPrompts.prompt_core && agentPrompts.prompt_core.trim() !== '';
            
            if (!temModulos) {
                return agentPrompts.prompt + `

CONTEXTO DA CONVERSA:
- Lead: ${context.lead_name}
- Plataforma: ${context.platform === 'instagram' ? 'Instagram' : 'LinkedIn'}
- Perfil: ${context.profile_url}
- SDR: ${getSdrName()}

Analise a resposta do lead e sugira a pr√≥xima mensagem que a SDR deve enviar. Seja espec√≠fico e objetivo.`;
            }
            
            const modulos = carregarModulos(estado);
            
            const contexto = `
---

CONTEXTO DESTA CONVERSA:
- Lead: ${context.lead_name}
- Plataforma: ${context.platform === 'instagram' ? 'Instagram' : 'LinkedIn'}
- Perfil: ${context.profile_url}
- SDR: ${getSdrName()}
- Estado atual: ${estado.toUpperCase()}
- √Årea confirmada: ${areaConfirmada ? 'Sim' : 'Pendente'}
- Dor identificada: ${dorIdentificada ? 'Sim' : 'Pendente'}
- Sess√£o proposta: ${sessaoProposta ? 'Sim' : 'N√£o'}
- Obje√ß√£o detectada: ${tipoObjecao || 'Nenhuma'}
- Total de mensagens: ${msgs.length}

INSTRU√á√ÉO PARA ESTE MOMENTO:
${instrucoesPorEstado[estado]}

Analise a resposta do lead e sugira a pr√≥xima mensagem que a SDR deve enviar. Seja espec√≠fico e objetivo.`;

            return modulos + contexto;
        }

        // =====================================================
        // ATUALIZA√á√ÉO DO INDICADOR DE FASE
        // =====================================================

        function updatePhaseIndicator() {
            if (!conversation) return;

            const mensagensLead = messages.filter(m => m.role === 'lead').map(m => m.content);
            const mensagensAssistant = messages.filter(m => m.role === 'assistant').map(m => m.content);
            const ultimaMensagemLead = mensagensLead[mensagensLead.length - 1] || '';

            const areaConfirmada = detectarArea(mensagensLead);
            const dorIdentificada = detectarDor(mensagensLead);
            const sessaoProposta = detectarSessaoProposta(mensagensAssistant);
            const { temObjecao, tipoObjecao } = detectarObjecao(ultimaMensagemLead);
            const leadAceitou = detectarAceitacao(ultimaMensagemLead, sessaoProposta);
            const leadRecusou = detectarRecusa(ultimaMensagemLead);
            const leadDesqualificado = detectarDesqualificacao(mensagensLead);

            const estado = determinarEstado({
                areaConfirmada,
                dorIdentificada,
                sessaoProposta,
                temObjecao,
                tipoObjecao,
                leadAceitou,
                leadRecusou,
                leadDesqualificado
            });

            const phaseLabels = {
                'abertura': 'üéØ Abertura',
                'transicao': 'üöÄ Transi√ß√£o',
                'objecao': '‚ö†Ô∏è Obje√ß√£o',
                'agendamento': 'üìÖ Agendamento',
                'desqualificado': '‚ùå Desqualificado'
            };

            const phaseClass = {
                'abertura': 'phase-abertura',
                'transicao': 'phase-transicao',
                'objecao': 'phase-objecao',
                'agendamento': 'phase-agendamento',
                'desqualificado': 'phase-desqualificado'
            };

            const statusText = conversation.status === 'open' ? 'üü° Em Aberto' : 
                               conversation.status === 'scheduled' ? '‚úÖ Agendada' : '‚ùå Perdida';
            
            const leadMeta = document.getElementById('leadMeta');
            leadMeta.innerHTML = `
                <span class="sdr-badge">üë§ ${getSdrName()}</span>
                ${conversation.platform === 'instagram' ? 'üì∑ Instagram' : 'üíº LinkedIn'} ‚Ä¢ 
                ${conversation.profile_url} ‚Ä¢ 
                Status: ${statusText}
                <span class="phase-indicator ${phaseClass[estado]}">${phaseLabels[estado]}${tipoObjecao ? ` (${tipoObjecao})` : ''}</span>
            `;
        }

        // =====================================================
        // DEBUG
        // =====================================================

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugPanel').classList.toggle('active', debugMode);
        }

        function logDebug(data) {
            if (!debugMode) return;
            
            const html = `
                <div><strong>SDR:</strong> ${data.sdr || '-'}</div>
                <div><strong>Estado:</strong> ${data.estado}</div>
                <div><strong>√Årea:</strong> ${data.variaveis.areaConfirmada ? '‚úÖ' : '‚ùå'}</div>
                <div><strong>Dor:</strong> ${data.variaveis.dorIdentificada ? '‚úÖ' : '‚ùå'}</div>
                <div><strong>Sess√£o:</strong> ${data.variaveis.sessaoProposta ? '‚úÖ' : '‚ùå'}</div>
                <div><strong>Obje√ß√£o:</strong> ${data.variaveis.tipoObjecao || 'Nenhuma'}</div>
                <div><strong>Aceitou:</strong> ${data.variaveis.leadAceitou ? '‚úÖ' : '‚ùå'}</div>
                <div><strong>M√≥dulos:</strong> ${data.modulosCarregados?.length || 0}</div>
            `;
            document.getElementById('debugContent').innerHTML = html;
            
            console.log('=== DIAGN√ìSTICO SDR ASSISTANT ===');
            console.log('SDR:', data.sdr);
            console.log('Vari√°veis:', data.variaveis);
            console.log('Estado:', data.estado);
            console.log('M√≥dulos:', data.modulosCarregados);
            console.log('================================');
        }

        // =====================================================
        // FUN√á√ïES PRINCIPAIS
        // =====================================================

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('agent');
            conversationId = urlParams.get('conv');
            currentSDR = urlParams.get('sdr');

            if (!agentId || !conversationId) {
                alert('‚ùå Link inv√°lido. Verifique a URL.');
                return;
            }

            if (!currentSDR) {
                alert('‚ùå Par√¢metro SDR n√£o encontrado. Volte ao dashboard.');
                return;
            }

            // Atualizar t√≠tulo
            document.title = `Chat - ${getSdrName()}`;

            try {
                // Inicializar Supabase com config centralizada
                supabaseClient = window.supabase.createClient(
                    CONFIG.SUPABASE_URL,
                    CONFIG.SUPABASE_ANON_KEY
                );

                // Carregar configura√ß√£o do Supabase
                await loadAgentConfig();
                
                // Carregar conversa
                await loadConversation();

            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                alert('‚ùå Erro: ' + error.message);
            }
        }

        window.onload = init;

        async function loadAgentConfig() {
            const { data, error } = await supabaseClient
                .from('agent_config')
                .select('*')
                .eq('agent_id', CONFIG.DEFAULT_AGENT_ID)
                .single();

            if (error) {
                if (error.code === 'PGRST116') {
                    throw new Error('Configura√ß√£o n√£o encontrada. Configure primeiro no admin.html');
                }
                throw error;
            }

            if (!data.api_key) {
                throw new Error('API Key n√£o configurada. Configure no admin.html');
            }

            // Montar agentConfig
            agentConfig = {
                agentId: data.agent_id,
                agentName: data.agent_name,
                apiKey: data.api_key,
                sdr: currentSDR
            };

            // Montar agentPrompts
            agentPrompts = {
                prompt_core: data.prompt_core || '',
                prompt_produto: data.prompt_produto || '',
                prompt_arquetipos: data.prompt_arquetipos || '',
                prompt_linguagem: data.prompt_linguagem || '',
                prompt_provas: data.prompt_provas || '',
                prompt_abertura: data.prompt_abertura || '',
                prompt_transicao: data.prompt_transicao || ''
            };

            console.log('üì¶ Prompts carregados:', Object.keys(agentPrompts).filter(k => agentPrompts[k]).length, 'm√≥dulos');
        }

        async function loadConversation() {
            try {
                const { data: convData, error: convError } = await supabaseClient
                    .from('conversations')
                    .select('*')
                    .eq('id', conversationId)
                    .single();

                if (convError) throw convError;
                conversation = convData;

                document.getElementById('leadName').textContent = conversation.lead_name;
                updatePhaseIndicator();

                const { data: msgData, error: msgError } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .eq('conversation_id', conversationId)
                    .order('created_at', { ascending: true });

                if (msgError) throw msgError;
                messages = msgData || [];
                renderMessages();
                updatePhaseIndicator();

            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao carregar conversa: ' + error.message);
            }
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            
            let html = '';
            
            for (const msg of messages) {
                const isLead = msg.role === 'lead';
                const avatar = isLead ? '<img src="avatar.png" alt="Lead">' : 'ü§ñ';
                const label = isLead ? 'Lead respondeu:' : 'Sugest√£o do Claude:';
                
                const content = isLead ? msg.content : marked.parse(msg.content);
                
                html += `
                    <div class="message ${msg.role}">
                        <div class="message-avatar">${avatar}</div>
                        <div>
                            <div class="message-label">${label}</div>
                            <div class="message-content">${content}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            container.appendChild(typingIndicator);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping(show) {
            document.getElementById('typingIndicator').classList.toggle('active', show);
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            input.value = '';

            try {
                const { data: leadMsg, error: leadError } = await supabaseClient
                    .from('messages')
                    .insert([{
                        conversation_id: conversationId,
                        role: 'lead',
                        content: content
                    }])
                    .select();

                if (leadError) throw leadError;

                messages.push(leadMsg[0]);
                renderMessages();
                showTyping(true);
                updatePhaseIndicator();

                const conversationHistory = messages.map(m => ({
                    role: m.role === 'lead' ? 'user' : 'assistant',
                    content: m.role === 'lead' 
                        ? `Lead respondeu: "${m.content}"`
                        : m.content
                }));

                const context = {
                    lead_name: conversation.lead_name,
                    platform: conversation.platform,
                    profile_url: conversation.profile_url
                };

                const systemPrompt = buildSystemPrompt(messages, context);
                
                console.log(`üìç [${getSdrName()}] Prompt montado: ${systemPrompt.length} chars`);

                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey: agentConfig.apiKey,
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: conversationHistory
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    if (PROXY_URL.includes('https://black-wood-a129.ferramentas-ac3.workers.dev/')) {
                        throw new Error('‚ö†Ô∏è Proxy n√£o configurado! Configure o Cloudflare Worker seguindo CLOUDFLARE_SETUP.md');
                    }
                    
                    throw new Error(errorData.error || 'Erro na API do Claude');
                }

                const data = await response.json();
                const assistantMessage = data.content[0].text;

                const { data: assistantMsg, error: assistantError } = await supabaseClient
                    .from('messages')
                    .insert([{
                        conversation_id: conversationId,
                        role: 'assistant',
                        content: assistantMessage
                    }])
                    .select();

                if (assistantError) throw assistantError;

                showTyping(false);
                messages.push(assistantMsg[0]);
                renderMessages();
                updatePhaseIndicator();

                await supabaseClient
                    .from('conversations')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('id', conversationId);

            } catch (error) {
                console.error('Erro:', error);
                showTyping(false);
                alert('‚ùå Erro ao enviar mensagem: ' + error.message);
            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        async function markAsScheduled() {
            if (!confirm('‚úÖ Marcar esta conversa como Agendada?')) return;

            try {
                const { error } = await supabaseClient
                    .from('conversations')
                    .update({ status: 'scheduled', updated_at: new Date().toISOString() })
                    .eq('id', conversationId);

                if (error) throw error;

                conversation.status = 'scheduled';
                updatePhaseIndicator();
                alert('‚úÖ Conversa marcada como Agendada!');
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao atualizar status');
            }
        }

        async function markAsInProgress() {
            if (!confirm('üü° Marcar esta conversa como Em Andamento?')) return;

            try {
                const { error } = await supabaseClient
                    .from('conversations')
                    .update({ 
                        status: 'open',
                        lost_reason: null,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', conversationId);

                if (error) throw error;

                conversation.status = 'open';
                updatePhaseIndicator();
                alert('üü° Conversa marcada como Em Andamento!');
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao atualizar status');
            }
        }

        function goHome() {
            const baseUrl = window.location.origin + window.location.pathname.replace('chat.html', '');
            window.location.href = `${baseUrl}dashboard.html?agent=${agentConfig.agentId}&sdr=${currentSDR}`;
        }

        function showRatingModal() {
            if (conversation.rating !== null && conversation.rating !== undefined) {
                selectedRating = conversation.rating;
                selectRating(selectedRating);
            }
            
            if (conversation.feedback_comments) {
                document.getElementById('ratingComments').value = conversation.feedback_comments;
            }
            
            document.getElementById('ratingModal').classList.add('active');
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('active');
            selectedRating = null;
            document.getElementById('ratingComments').value = '';
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function selectRating(rating) {
            selectedRating = rating;
            
            document.querySelectorAll('.rating-btn').forEach(btn => {
                if (parseInt(btn.dataset.rating) === rating) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        async function saveRating() {
            if (selectedRating === null) {
                alert('‚ö†Ô∏è Por favor, selecione uma nota de 0 a 10');
                return;
            }

            const comments = document.getElementById('ratingComments').value.trim();

            try {
                const { error } = await supabaseClient
                    .from('conversations')
                    .update({ 
                        rating: selectedRating,
                        feedback_comments: comments || null,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', conversationId);

                if (error) throw error;

                conversation.rating = selectedRating;
                conversation.feedback_comments = comments;
                
                closeRatingModal();
                alert('‚úÖ Avalia√ß√£o salva com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao salvar avalia√ß√£o: ' + error.message);
            }
        }

        function showLostModal() {
            document.getElementById('lostModal').classList.add('active');
        }

        function closeLostModal() {
            document.getElementById('lostModal').classList.remove('active');
            document.getElementById('lostReason').value = '';
        }

        async function markAsLost() {
            const reason = document.getElementById('lostReason').value.trim();

            if (!reason) {
                alert('‚ö†Ô∏è Por favor, informe o motivo');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('conversations')
                    .update({ 
                        status: 'lost', 
                        lost_reason: reason,
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', conversationId);

                if (error) throw error;

                const baseUrl = window.location.origin + window.location.pathname.replace('chat.html', '');
                window.location.href = `${baseUrl}dashboard.html?agent=${agentConfig.agentId}&sdr=${currentSDR}`;
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao atualizar status');
            }
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function deleteConversation() {
            try {
                const { error } = await supabaseClient
                    .from('conversations')
                    .delete()
                    .eq('id', conversationId);

                if (error) throw error;

                const baseUrl = window.location.origin + window.location.pathname.replace('chat.html', '');
                window.location.href = `${baseUrl}dashboard.html?agent=${agentConfig.agentId}&sdr=${currentSDR}`;
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao apagar conversa: ' + error.message);
            }
        }
    </script>
</body>
</html>
